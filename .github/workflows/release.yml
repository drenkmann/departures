name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Wait for continuous release to finish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          while true; do
            IN_PROGRESS=$(gh api "/repos/${{ github.repository }}/actions/workflows/continuous-release.yml/runs?branch=dev&status=in_progress" -q '.total_count')
            QUEUED=$(gh api "/repos/${{ github.repository }}/actions/workflows/continuous-release.yml/runs?branch=dev&status=queued" -q '.total_count')
            if [[ "$IN_PROGRESS" == "0" && "$QUEUED" == "0" ]]; then
              break
            fi
            echo "Waiting for continuous release to finish (in_progress=$IN_PROGRESS, queued=$QUEUED)..."
            sleep 20
          done

      - name: Read version name
        id: version
        run: |
          VERSION_NAME=$(grep '^version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT

      - name: Authenticate to Google Play
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
          token_format: access_token
          access_token_scopes: https://www.googleapis.com/auth/androidpublisher

      - name: Promote internal release to open testing
        env:
          ACCESS_TOKEN: ${{ steps.auth.outputs.access_token }}
          PACKAGE_NAME: dev.drenkmann.departures
        run: |
          set -euo pipefail
          EDIT_ID=$(curl -s -X POST \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE_NAME/edits" | jq -r '.id')

          INTERNAL_TRACK=$(curl -s \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE_NAME/edits/$EDIT_ID/tracks/internal")

          echo "Internal track response: $INTERNAL_TRACK"

          VERSION_CODE=$(echo "$INTERNAL_TRACK" | jq -r '[.releases[]?.versionCodes[]? | tonumber] | max')
          if [[ -z "$VERSION_CODE" || "$VERSION_CODE" == "null" ]]; then
            echo "No version codes found in internal track."
            exit 1
          fi

          RELEASE_PAYLOAD=$(echo "$INTERNAL_TRACK" | jq -c --arg vc "$VERSION_CODE" '[.releases[]? | select(.versionCodes[]? == $vc)][0]' )
          if [[ -z "$RELEASE_PAYLOAD" || "$RELEASE_PAYLOAD" == "null" ]]; then
            echo "No matching release found for version code $VERSION_CODE."
            exit 1
          fi

          BETA_BODY=$(jq -n --argjson release "$RELEASE_PAYLOAD" '{track:"beta", releases:[$release]}')

          curl -s -X PUT \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$BETA_BODY" \
            "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE_NAME/edits/$EDIT_ID/tracks/beta" > /dev/null

          curl -s -X POST \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE_NAME/edits/$EDIT_ID:commit" > /dev/null

      - name: Download continuous release APKs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p release-assets
          gh release download continuous --pattern "*.apk" --dir release-assets

      - name: Delete existing release and tag
        run: |
          gh release delete "v${{ steps.version.outputs.version_name }}" --cleanup-tag -y || true
          git push origin ":refs/tags/v${{ steps.version.outputs.version_name }}" || true
          git tag -d "v${{ steps.version.outputs.version_name }}" || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub release
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ steps.version.outputs.version_name }}
          commit: ${{ github.sha }}
          name: v${{ steps.version.outputs.version_name }}
          prerelease: false
          allowUpdates: false
          draft: false
          generateReleaseNotes: true
          artifacts: |
            release-assets/*.apk
